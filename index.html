<!DOCTYPE html>
<html>
	<head>
		<title>Game</title>
		<meta charset="utf-8"/>
		<script src="nimble.js" type="text/javascript"></script>
		<script src="pixi.js" type="text/javascript"></script>
		<script src="gm.js" type="text/javascript"></script>
	</head>
	<body>
		<script type="text/javascript">
//TEST GAME FOR GMJS
oncontextmenu = function(){return false;};
window.onload = function(){'use strict';
	
	
	//Setup Sprites
	var Sprites = [{name:'spr_treasure', path:'images/treasurebox.png'},
	{path:'images/sprites.png', strip:[{name:'spr_enemy', tile:{x:0,y:0,w:64,h:64}}, {name:'spr_character', tile:{x:0,y:64,w:64,h:64}}]},
	{name:'spr_wall', path:'images/wall.png'},
	{name:'spr_bullet', path:'images/bullet.png'}];
	
	if(typeof(GMJS) == 'object'){
		GMJS.StartGameEngine(GameInit, Sprites);
	} else return console.error('GMJS not found');
	
	var g = GMJS;
	var Cont, Enemy, TreasureBox, Character, Wall, Bullet, CollisionObjects, GatherObjects;
	function GameInit(){
		//Setup Fonts
		var PlayerFont = g.create_text_style({fontFamily: 'Arial', fontSize: 10, fill:0xFFFFFF});
		//Setup Objects
		Cont = new g.object({
				name:'controller',
				creation:function(t){
					t.draw_kills = g.create_text('', 0, 0, PlayerFont);
					t.draw_kills.align('center');
					t.create_chest.time = 60 + Math.random()*100;
					t.create_player.time = 50;//create player first
					t.create_enemy.time = 100;
					t.kills = 0;
					t.player = null;
				},
				step:function(t){
					if(t.player){
						t.draw_kills.text = 'Kills: ' + t.kills.toString();
						t.draw_kills.x = t.player.x;
						t.draw_kills.y = t.player.y - 22;
					}
				},
				alarms:[
				{name:'create_chest', code:function(t){TreasureBox.instance_create(Math.random()*g.room.width,Math.random()*g.room.height);t.create_chest.time = 10*t.player.points + 100*(TreasureBox.instance_number() + 1) + Math.random()*100;}},
				{name:'create_player', code:function(t){t.player = Character.instance_create(g.room.width/2, g.room.height/2);}},
				{name:'create_enemy', code:function(t){
					do {var xx = 64 + Math.random()*(g.room.width - 128), yy = 64 + Math.random()*(g.room.height - 128);
					} while (g.collision_point(xx, yy, 'collision_objects'));
					Enemy.instance_create(xx, yy);t.create_enemy.time = Math.max(100 + Math.random()*(1500 - t.kills), 50);}}
				]
			});
		GatherObjects = new g.object({
				name:'gather_objects'
			});
		CollisionObjects = new g.object({
			name:'collision_objects',
			parent:GatherObjects
		});
		Bullet = new g.object({
				name:'Bullet',
				image:'spr_bullet',
				mask:{x:0,y:0,w:8,h:8},
				creation:function(t){
					t.xscale = 0.25;
					t.yscale = 0.25;
					t.spd = 8;
					t.image_alpha = 0;
					t.dir = [0,0,0,0];//lrud
				},
				step:function(t){
					t.image_angle = (t.dir[0])?-90 + 45*t.dir[2] - 45*t.dir[3]:45*t.dir[1] - 45*t.dir[0];
					if(t.dir[3]){
						t.image_angle = 180 - 45*t.dir[1] + 45*t.dir[0];
					}
					if(t.dir[1]){
						t.image_angle = 90 - 45*t.dir[2] + 45*t.dir[3];
					}
					t.image_alpha = 1;
					if(t.dir[0]) t.x -= t.spd;
					if(t.dir[1]) t.x += t.spd;
					if(t.dir[2]) t.y -= t.spd;
					if(t.dir[3]) t.y += t.spd;
				},
				collision:[
					{object:CollisionObjects, code:function(t, other){
						t.instance_destroy();
					}}
				]
			});
		TreasureBox = new g.object({
				name:'TreasureBox',
				image:'spr_treasure',
				creation:function(t){
					t.depth = g.room.height - t.y;
					t.image_alpha = 0;
				},
				step:function(t){
					if(t.image_alpha < 1) t.image_alpha += 0.02;
				},
				collision:[{object:GatherObjects, code:function(t,other){if(t.image_alpha >= 1 || other.object_index == Wall)t.instance_destroy();}}]
			});
		Enemy = new g.object({
			image:'spr_enemy',
			name:'Enemy',
			parent:GatherObjects,
			depth:-3,
			creation:function(t){
				t.life = 100;
				t.xscale = 0.5;
				t.yscale = 0.5;
				t.reset_keys = function(){					
					t.left = false;
					t.right = false;
					t.up = false;
					t.down = false;
				}
				t.reset_keys();
				t.reset_motion.time = 10;
				t.image_alpha = 0;
				t.spd = 2;
			},
			destroyed:function(t){
				Cont.instances[0].kills++;
			},
			step:function(t){
				t.depth = g.room.height - t.y;
				if(t.image_alpha < 1) t.image_alpha += 0.1;
				if(t.up){t.y -= t.spd;}
				if(t.down){t.y += t.spd;}
				if(t.left){t.x -= t.spd;}
				if(t.right){t.x += t.spd;}
			},
			end_step:function(t){
				if(t.image_alpha >= 1){
					t.graphics.lineStyle(1, 0x600000);
					t.graphics.drawRect(t.x-16, t.y-t.sprite.height/2-10, 32, 8);
					t.graphics.lineStyle(0);
					t.graphics.beginFill(0XFF0000);
					t.graphics.drawRect(t.x-16, t.y-t.sprite.height/2-10, 32*t.life/100, 8);
					t.graphics.endFill();
				}
			},
			alarms:[
				{name:'reset_motion', code:function(t){
					t.reset_keys();
					t.left = Math.round(Math.random());
					t.right = Math.round(Math.random());
					t.up = Math.round(Math.random());
					t.down = Math.round(Math.random());
					t.reset_motion.time = 80 + Math.random()*100;
				}}
			],
			collision:[
				{object:CollisionObjects, code:function(t, other){
					if(t.left && other.x < t.x && Math.abs(t.y - other.y) < other.sprite.height-8) t.x = t.xprevious;
					if(t.right && other.x > t.x && Math.abs(t.y - other.y) < other.sprite.height-8) t.x = t.xprevious;
					if(t.up && other.y < t.y && Math.abs(t.x - other.x) < other.sprite.width-8) t.y = t.yprevious;
					if(t.down && other.y > t.y && Math.abs(t.x - other.x) < other.sprite.width-8) t.y = t.yprevious;
					t.reset_motion.time = 0;
				}},
				{object:Bullet, code:function(t, other){
					other.instance_destroy();
					t.life-= 10 + Math.random(20);
					if(t.life < 0) {t.life = 0;t.instance_destroy();}
				}}
			]
		});	
		Wall = new g.object({
			name:'Wall',
			image:'spr_wall',
			parent:CollisionObjects,
			creation:function(t){
				t.depth = g.room.height - t.y;
			}
		});
		Character = new g.object({
			name:'Character',
			image:'spr_character',
			parent:GatherObjects,
			creation:function(t){
				t.points = 0;
				t.text = g.create_text('Game', 0, 0, PlayerFont);
				t.text.align('center');
				t.text.depth = -1;
				t.spd = 3;
				t.xscale = 0.5;
				t.yscale = 0.5;
				t.up = false;t.down = false;t.left = false;t.right = false;
				t.last_dir = [0,1,0,0];
			},
			step:function(t){
				t.text.x = t.x;
				t.text.y = t.y - 32;
				t.text.text = 'Points: '+t.points.toString();
				
				t.depth = g.room.height - t.y;
				t.up = g.keyboard.up;
				t.down = (g.keyboard.down && !t.up);
				t.left = g.keyboard.left;
				t.right = (g.keyboard.right && !t.left);
				if(t.left || t.right || t.up || t.down) t.last_dir = [t.left, t.right, t.up, t.down];
				if(t.up){t.y -= t.spd;}
				if(t.down){t.y += t.spd;}
				if(t.left){t.x -= t.spd;}
				if(t.right){t.x += t.spd;}
				if(g.keyboard_check_pressed('control')){
					var ii=Bullet.instance_create(t.x + (t.last_dir[0]*-16) + (t.last_dir[1]*16), t.y + (t.last_dir[2]*-16) + (t.last_dir[3]*16));
					ii.dir = [].concat(t.last_dir);
				}
			},
			collision:[
				{object:CollisionObjects, code:function(t, other){
					if(t.left && other.x < t.x && Math.abs(t.y - other.y) < other.sprite.height-8) t.x = t.xprevious;
					if(t.right && other.x > t.x && Math.abs(t.y - other.y) < other.sprite.height-8) t.x = t.xprevious;
					if(t.up && other.y < t.y && Math.abs(t.x - other.x) < other.sprite.width-8) t.y = t.yprevious;
					if(t.down && other.y > t.y && Math.abs(t.x - other.x) < other.sprite.width-8) t.y = t.yprevious;
				}}, {object:TreasureBox, code:function(t, other){
					if(other.image_alpha >= 1) t.points ++;
				}}
			]
		});

		Cont.instance_create();
		for(var ww = 0; ww < g.room.width/32; ww++){
			Wall.instance_create(32*ww + 16, 16);
			Wall.instance_create(32*ww + 16, g.room.height - 16);
		}
		for(var hh = 1; hh < g.room.height/32 - 1; hh++){
			Wall.instance_create(16, 32*hh + 16);
			Wall.instance_create(g.room.width - 16, 32*hh + 16);
		}
	}
};
	</script>
	</body>
</html>